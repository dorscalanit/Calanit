<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>כל המשרות | כלנית</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f8fafc; }
        .job-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .job-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        select:disabled { background-color: #e5e7eb; cursor: not-allowed; }
        .bubble { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <header id="header-placeholder"></header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="mb-8 text-center">
            <h1 class="text-4xl md:text-5xl font-black text-gray-800">מצא/י את המשרה הבאה שלך</h1>
            <p class="text-lg text-gray-600 mt-2">סנן/י את התוצאות ומצא/י את ההזדמנות המושלמת עבורך.</p>
        </div>

        <div class="flex flex-col md:flex-row gap-8">
            <!-- Filters Sidebar -->
            <aside class="w-full md:w-1/4 lg:w-1/5">
                <div class="bg-white p-6 rounded-2xl shadow-lg sticky top-28">
                    <h3 class="text-xl font-bold mb-6 border-b pb-3 flex items-center gap-2"><i class="fas fa-filter text-blue-500"></i> סינון תוצאות</h3>
                    <div class="space-y-6">
                        <div><label for="keyword-search" class="font-semibold block mb-2">חיפוש חופשי</label><input type="text" id="keyword-search" placeholder="שם תפקיד, חברה, שכר..." class="w-full border-gray-300 rounded-lg shadow-sm"></div>
                        <div>
                            <label class="font-semibold block mb-2">מיקום</label>
                            <div class="relative"><input type="text" id="location-search" placeholder="הקלד/י עיר..." class="w-full border-gray-300 rounded-lg shadow-sm"><div id="location-autocomplete" class="absolute w-full bg-white border z-10 rounded-b-lg max-h-48 overflow-y-auto hidden"></div></div>
                            <div id="location-bubbles" class="flex flex-wrap gap-1 mt-2"></div>
                        </div>
                        <div>
                            <label class="font-semibold block mb-2">תחום</label>
                            <select id="main-category" class="w-full border-gray-300 rounded-lg shadow-sm"></select>
                            <select id="subcategory" disabled class="w-full border-gray-300 rounded-lg shadow-sm mt-2"></select>
                            <div id="category-bubbles" class="flex flex-wrap gap-1 mt-2"></div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Job Listings -->
            <section id="job-listings" class="w-full md:w-3/4 lg:w-4/5">
                <div class="mb-4 text-sm text-gray-500 font-medium">נמצאו <span id="job-count" class="font-bold">0</span> משרות</div>
                <div id="jobs-container" class="space-y-6">
                    <!-- Job cards will be injected here -->
                </div>
                <div id="no-results" class="hidden text-center bg-white p-12 rounded-2xl shadow-md">
                    <i class="fas fa-search-minus text-5xl text-gray-400 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-700">לא נמצאו משרות התואמות לחיפוש</h3>
                    <p class="text-gray-500 mt-2">נסי/ה להסיר חלק מהמסננים או לבדוק שוב מאוחר יותר.</p>
                </div>
                 <div id="jobs-loader" class="text-center p-12">
                    <i class="fas fa-spinner fa-spin text-5xl text-blue-500"></i>
                </div>
            </section>
        </div>
    </main>
    
    <div id="cv-modal-container"></div>
    <footer id="footer-placeholder"></footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, orderBy, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- Firebase Initialization ---
        const firebaseConfig = { apiKey: "AIzaSyAOKMJabnJ9JGE5CuclCCSjv5Bo3rT49Cw", authDomain: "calanit-31a32.firebaseapp.com", projectId: "calanit-31a32", storageBucket: "calanit-31a32.appspot.com", messagingSenderId: "91430351613", appId: "1:91430351613:web:ae46b2063f2d4b71428494" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Global State ---
        let allJobs = [];
        let allCities = [];
        let jobTypesData = {};
        let filters = {
            keyword: '',
            locations: new Set(),
            categories: new Set()
        };

        // --- Data Loading ---
        async function loadData() {
            [allCities, jobTypesData, allJobs] = await Promise.all([
                fetch('cities.json').then(res => res.json()).catch(() => []),
                fetch('jobTypesHierarchical.json').then(res => res.json()).catch(() => ({})),
                getDocs(query(collection(db, "jobs"), orderBy("createdAt", "desc"))).then(snapshot => snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })))
            ]);
        }

        // --- Job Rendering Logic ---
        function renderJobs() {
            const container = document.getElementById('jobs-container');
            const noResultsEl = document.getElementById('no-results');
            const jobCountEl = document.getElementById('job-count');
            container.innerHTML = '';

            const keyword = filters.keyword.toLowerCase();
            
            const filteredJobs = allJobs.filter(job => {
                const keywordMatch = !keyword || 
                    (job.title && job.title.toLowerCase().includes(keyword)) ||
                    (job.description && job.description.toLowerCase().includes(keyword)) ||
                    (job.locations && job.locations.some(loc => loc.toLowerCase().includes(keyword))) ||
                    (job.categories && job.categories.some(cat => cat.toLowerCase().includes(keyword)));

                const locationMatch = filters.locations.size === 0 || 
                    (job.locations && job.locations.some(loc => filters.locations.has(loc)));
                
                const categoryMatch = filters.categories.size === 0 || 
                    (job.categories && job.categories.some(cat => filters.categories.has(cat)));

                return keywordMatch && locationMatch && categoryMatch;
            });

            jobCountEl.textContent = filteredJobs.length;

            if (filteredJobs.length === 0) {
                noResultsEl.style.display = 'block';
            } else {
                noResultsEl.style.display = 'none';
                filteredJobs.forEach(job => {
                    const jobCard = document.createElement('div');
                    jobCard.className = 'job-card bg-white p-6 rounded-xl shadow-sm border border-transparent hover:border-blue-500 transition-all duration-300';
                    jobCard.innerHTML = `
                        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">${job.title}</h2>
                                <div class="text-sm text-gray-500 mt-2 flex flex-wrap items-center gap-x-4 gap-y-1">
                                    <span><i class="fas fa-map-marker-alt mr-1 text-gray-400"></i> ${job.locations ? job.locations.join(', ') : ''}</span>
                                    <span><i class="fas fa-briefcase mr-1 text-gray-400"></i> ${job.categories ? job.categories.join(', ') : ''}</span>
                                </div>
                            </div>
                            <button class="open-cv-modal-btn bg-blue-500 text-white font-bold px-6 py-2 rounded-lg hover:bg-blue-600 transition whitespace-nowrap" data-job-id="${job.id}" data-job-title="${job.title}">הגש מועמדות</button>
                        </div>
                        <p class="mt-4 text-gray-600 leading-relaxed line-clamp-3">${job.description}</p>
                    `;
                    container.appendChild(jobCard);
                });
                // Re-attach event listeners for the newly created buttons
                document.querySelectorAll('.open-cv-modal-btn').forEach(btn => btn.addEventListener('click', () => window.openCVModal(btn.dataset.jobId, btn.dataset.jobTitle)));
            }
            document.getElementById('jobs-loader').style.display = 'none';
        }

        // --- Filter Setup Logic ---
        function setupFilters() {
            const keywordInput = document.getElementById('keyword-search');
            keywordInput.addEventListener('input', () => { filters.keyword = keywordInput.value; renderJobs(); });

            function setupBubbleFilter(config) {
                const { input, autocompleteContainer, bubblesContainer, dataSet, filterSet, color } = config;
                input.addEventListener('input', () => {
                    const query = input.value.trim();
                    autocompleteContainer.innerHTML = '';
                    if (query.length < 1) { autocompleteContainer.classList.add('hidden'); return; }
                    const filtered = dataSet.filter(i => i.startsWith(query) && !filterSet.has(i)).slice(0, 5);
                    if (filtered.length) {
                        filtered.forEach(itemText => {
                            const item = document.createElement('div');
                            item.className = 'p-2 cursor-pointer hover:bg-gray-100';
                            item.textContent = itemText;
                            item.addEventListener('click', () => addItem(itemText));
                            autocompleteContainer.appendChild(item);
                        });
                        autocompleteContainer.classList.remove('hidden');
                    } else { autocompleteContainer.classList.add('hidden'); }
                });
                const addItem = (item) => { filterSet.add(item); renderBubbles(); renderJobs(); input.value = ''; autocompleteContainer.classList.add('hidden'); };
                const removeItem = (item) => { filterSet.delete(item); renderBubbles(); renderJobs(); };
                const renderBubbles = () => {
                    bubblesContainer.innerHTML = '';
                    filterSet.forEach(item => {
                        const bubble = document.createElement('div');
                        bubble.className = `bubble bg-${color}-100 text-${color}-800 text-xs font-semibold px-2 py-1 rounded-full flex items-center gap-2`;
                        bubble.innerHTML = `<span>${item}</span><button class="text-${color}-500">&times;</button>`;
                        bubble.querySelector('button').addEventListener('click', () => removeItem(item));
                        bubblesContainer.appendChild(bubble);
                    });
                };
                document.addEventListener('click', e => { if (!input.contains(e.target)) autocompleteContainer.classList.add('hidden'); });
                return { render: renderBubbles };
            }

            const locationBubbleSystem = setupBubbleFilter({ input: document.getElementById('location-search'), autocompleteContainer: document.getElementById('location-autocomplete'), bubblesContainer: document.getElementById('location-bubbles'), dataSet: allCities, filterSet: filters.locations, color: 'blue' });
            
            const mainCat = document.getElementById('main-category');
            const subCat = document.getElementById('subcategory');
            const catBubbles = document.getElementById('category-bubbles');
            Object.keys(jobTypesData).sort().forEach(cat => mainCat.add(new Option(cat, cat)));
            mainCat.addEventListener('change', () => {
                subCat.innerHTML = '<option value="">בחר תת קטגוריה</option>';
                if (mainCat.value) { subCat.disabled = false; jobTypesData[mainCat.value].forEach(sc => subCat.add(new Option(sc, sc))); } 
                else { subCat.disabled = true; }
            });
            subCat.addEventListener('change', () => {
                if (subCat.value) { filters.categories.add(subCat.value); categoryBubbleSystem.render(); renderJobs(); subCat.value = ''; }
            });
            const categoryBubbleSystem = {
                render: () => {
                    catBubbles.innerHTML = '';
                    filters.categories.forEach(item => {
                        const bubble = document.createElement('div');
                        bubble.className = `bubble bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded-full flex items-center gap-2`;
                        bubble.innerHTML = `<span>${item}</span><button class="text-green-500">&times;</button>`;
                        bubble.querySelector('button').addEventListener('click', () => { filters.categories.delete(item); this.render(); renderJobs(); });
                        catBubbles.appendChild(bubble);
                    });
                }
            };

            // Initialize filters from URL
            const params = new URLSearchParams(window.location.search);
            if (params.has('keyword')) { keywordInput.value = params.get('keyword'); filters.keyword = keywordInput.value; }
            if (params.has('locations')) { params.get('locations').split(',').forEach(loc => filters.locations.add(loc)); locationBubbleSystem.render(); }
            if (params.has('categories')) { params.get('categories').split(',').forEach(cat => filters.categories.add(cat)); categoryBubbleSystem.render(); }
        }

        // --- Component Loading ---
        function loadComponent(url, id, cb) { fetch(url).then(res => res.ok ? res.text() : Promise.reject(res)).then(html => { document.getElementById(id).innerHTML = html; if (cb) cb(); }).catch(err => console.error(`Failed loading ${url}`)); }

        // --- Main Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadComponent('menu.html', 'header-placeholder', () => { document.getElementById('mobile-menu-button')?.addEventListener('click', () => document.getElementById('mobile-menu')?.classList.toggle('hidden')); });
            loadComponent('footer.html', 'footer-placeholder');
            loadComponent('cv-modal.html', 'cv-modal-container', () => {
                // Attach listeners after the modal is loaded
                const modalContainer = document.getElementById('cv-modal-container');
                const form = modalContainer.querySelector('#cv-form-injected');
                if(form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const submitBtn = form.querySelector('#cv-submit-button-injected');
                        const msgEl = form.querySelector('#cv-form-message-injected');
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                        const cvFile = form.querySelector('#cvFile-injected').files[0];
                        if (!cvFile) {
                           msgEl.className = 'text-red-600 font-semibold';
                           msgEl.textContent = 'חובה להעלות קובץ.';
                           submitBtn.disabled = false;
                           submitBtn.textContent = 'שלח/י קורות חיים';
                           return;
                        }
                        const storageRef = ref(storage, `cvs/${Date.now()}_${cvFile.name}`);
                        try {
                            await uploadBytes(storageRef, cvFile);
                            const fileURL = await getDownloadURL(storageRef);
                            await addDoc(collection(db, "jobApplicants"), { 
                                firstName: form.querySelector('#firstName-injected').value, 
                                lastName: form.querySelector('#lastName-injected').value, 
                                phone: form.querySelector('#phone-injected').value, 
                                fileURL, 
                                jobId: window.currentJobIdForModal, 
                                jobTitle: window.currentJobTitleForModal,
                                createdAt: serverTimestamp() 
                            });
                            msgEl.className = 'text-green-600 font-semibold';
                            msgEl.textContent = 'הפרטים נשלחו בהצלחה!';
                            form.reset();
                            setTimeout(() => document.getElementById('cv-modal')?.classList.add('hidden'), 2000);
                        } catch (err) {
                            msgEl.className = 'text-red-600 font-semibold';
                            msgEl.textContent = 'אירעה שגיאה בשליחה.';
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'שלח/י קורות חיים';
                        }
                    });
                }
                modalContainer.querySelector('#close-cv-modal')?.addEventListener('click', () => {
                    modalContainer.querySelector('#cv-modal')?.classList.add('hidden');
                });
            });
            
            // Global function to open the CV modal
            window.openCVModal = (jobId, jobTitle) => {
                window.currentJobIdForModal = jobId;
                window.currentJobTitleForModal = jobTitle;
                const modal = document.getElementById('cv-modal');
                if(modal) {
                    modal.querySelector('#cv-modal-title-injected').textContent = `הגשת מועמדות למשרת "${jobTitle}"`;
                    modal.classList.remove('hidden');
                }
            }

            await loadData();
            setupFilters();
            renderJobs();
        });
    </script>
</body>
</html>

